<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Contact Manager</title>
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/handlebars.js"></script>
<style>
  #new-contact-form {
    display: none
  }
  table,th,td {
    border: 1px solid black;
  }
</style>
</head>
<body>
  <header>
    <h1>Contact Manager</h1>
  </header>
   <div id="main-container">
    <button id="add-contact-button">Add Contact</button>
    <br><br>
    <button id="view-contacts-button">View Contacts</button>
    <br><br>
    <form id="search-form">
      <input type="text" id="search-input" name="search" placeholder="search">
      <button type="submit" id="search-button">Search</button>
    </form>
  </div>
  <br>
  <div id="new-contact-form">
    <h2>Add a New Contact:</h2>
    <form>
      <label for="full-name">Full Name:</label>
      <input type="text" id="full-name" name="full-name">
      <br><br>
      <label for="email-address">Email Address:</label>
      <input type="email" id="email-address" name="email-address">
      <br><br>
      <label for="telephone-number">Telephone Number:</label>
      <input type="tel" id="telephone-number" name="telephone-number">
      <br><br>
      <label for="tags">Tags:</label>
      <input type="text" id="tags" name="tags">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button" id="cancel-new-contact">Cancel</button>
    </form>
  </div>
  <div id="edit-contact-form">
    <h2>Edit Contact:</h2>
    <form>
      <label for="full-name">Full Name:</label>
      <input type="text" id="full-name" name="full-name">
      <br><br>
      <label for="email-address">Email Address:</label>
      <input type="email" id="email-address" name="email-address">
      <br><br>
      <label for="telephone-number">Telephone Number:</label>
      <input type="tel" id="telephone-number" name="telephone-number">
      <br><br>
      <label for="tags">Tags:</label>
      <input type="text" id="tags" name="tags">
      <br><br>
      <button type="submit" id="update-edit-contact">Update</button>
      <button type="button" id="cancel-edit-contact">Cancel</button>
    </form>
  </div>
  <div id="all-contacts-table">
    <h2>Contact List:</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <br><br>
    <button type="button" id="home-button">Home</button>
  </div>
  <div id="search-results-table" style="display:none">
    <h2>Search Results:</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <br><br>
    <button type="button" id="search-results-home-button">Home</button>
    <button type="button" id="view-all-contacts-button">View All Contacts</button>
  </div>
<script>

$(document).ready(function() {
  $('#new-contact-form, #all-contacts-table, #edit-contact-form, #search-results-table').hide();
  $('#add-contact-button').click(() => $('#main-container').hide() && $('#new-contact-form').show());

  function createTagLinks(tags) {
    return tags ? tags.split(',').map(tag => $('<a></a>').text(tag.trim()).attr('href', '#')) : [];
  }

  function fetchContacts() {
    $.get('http://localhost:3000/api/contacts', function(response) {
        $('#all-contacts-table tbody').empty();
        response.forEach(contact => {
            const tagSpan = $('<span>').append(createTagLinks(contact.tags));
            $('<tr>').append(
                $('<td>').text(contact.full_name),
                $('<td>').text(contact.phone_number),
                $('<td>').text(contact.email),
                $('<td>').append(tagSpan),
                $('<td>').html(`<button class="edit-contact" data-id="${contact.id}">Edit</button> <button class="delete-contact" data-id="${contact.id}">Delete</button>`)
            ).appendTo('#all-contacts-table tbody');
        });
        $('.delete-contact').click(function() {
            const contactId = $(this).data('id');
            $.ajax({
                method: 'DELETE',
                url: `http://localhost:3000/api/contacts/${contactId}`,
                context: this,
                success: function(response) {
                    alert('Successfully deleted contact!');
                    $(this).closest('tr').remove();
                },
                error: function(xhr, status, error) {
                    alert('Error deleting contact :(');
                    console.log('Error:', error);
                }
            });
        });
        $('.edit-contact').click(function() {
            const contactId = $(this).data('id');
            $('#all-contacts-table').hide();
            $.get(`http://localhost:3000/api/contacts/${contactId}`, function(response) {
                $('#edit-contact-form #full-name').val(response.full_name);
                $('#edit-contact-form #telephone-number').val(response.phone_number);
                $('#edit-contact-form #email-address').val(response.email);
                $('#edit-contact-form #tags').val(response.tags);
                $('<input>', { type: 'hidden', name: 'id', value: contactId }).appendTo('#edit-contact-form');
                $('#edit-contact-form').show();
            });
        });
    });
  }


  fetchContacts();

  $('#view-contacts-button').click(function() {$('#main-container').hide(); $('#all-contacts-table').show(); fetchContacts();});
  $('#search-button').click(function() { $('#main-container').hide(); }).next('#search-results-table').show();
  $('#cancel-new-contact').click(function() {$('#new-contact-form').hide(); $('#main-container').show();});
  $('#cancel-edit-contact').click(function() {$('#edit-contact-form').hide(); $('#all-contacts-table').show();});
  $('#home-button').click(function() {$('#all-contacts-table').hide(); $('#main-container').show();});
  $("#search-results-home-button").click(function() {$('#search-results-table').hide(); $('#main-container').show();});
  $('#view-all-contacts-button').click(function() {$('#search-results-table').hide(); $('#all-contacts-table').show(); fetchContacts();});


  $('#new-contact-form form').submit(function(event) {
    event.preventDefault();

    var formData = {
      full_name: $('#full-name').val(),
      email: $('#email-address').val(),
      phone_number: $('#telephone-number').val(),
      tags: $('#tags').val()
    };

    $.ajax({
      method: 'POST',
      url: 'http://localhost:3000/api/contacts/',
      data: formData,
      success: function(response) {
        alert('Successfully added new contact!');
        $('#new-contact-form').hide();
        $('#main-container').show();
        $('#new-contact-form form')[0].reset();
      },
      error: function(xhr, status, error) {
        alert('Error adding new contact :(');
        console.log('Error:', error);
      }
    });
  });

  $('#edit-contact-form form').submit(function(event) {
    event.preventDefault(); 
    var contactId = $('#edit-contact-form input[type=hidden]').val();

    var formData = {
      full_name: $('#edit-contact-form #full-name').val(),
      email: $('#edit-contact-form #email-address').val(),
      phone_number: $('#edit-contact-form #telephone-number').val(),
      tags: $('#edit-contact-form #tags').val()
    };

    $.ajax({
      method: 'PUT',
      url: 'http://localhost:3000/api/contacts/' + contactId,
      data: formData,
      success: function(response) {
        alert('Successfully updated contact!');
        $('#edit-contact-form input[name="id"]').remove();
        $('#edit-contact-form').hide();
        $('#all-contacts-table').show();
        fetchContacts();
      },
      error: function(xhr, status, error) {
        alert('Error updating contact :(');
        console.log('Error:', error);
      }
    });
  });

  $('#search-form').submit(function(event) {
    event.preventDefault();
    const searchTerm = $('#search-input').val().trim().toLowerCase();

    $.get('/api/contacts', function(response) {
        const filteredContacts = response.filter(contact => ['full_name', 'email', 'phone_number', 'tags'].some(field => contact[field].toLowerCase().includes(searchTerm)));

        $('#all-contacts-table').hide();
        $('#search-results-table').show();

        const searchTableBody = $('#search-results-table tbody');
        searchTableBody.empty();

        filteredContacts.forEach(contact => {
            const row = $('<tr></tr>');
            $('<td></td>').text(contact.full_name).appendTo(row);
            $('<td></td>').text(contact.phone_number).appendTo(row);
            $('<td></td>').text(contact.email).appendTo(row);

            const tagSpan = $('<span></span>');
            createTagLinks(contact.tags).forEach((link, index) => {
                if (index > 0) $('<span>, </span>').appendTo(tagSpan);
                tagSpan.append(link);
            });
            $('<td></td>').append(tagSpan).appendTo(row);

            $('<td></td>').html(`<button class="edit-contact" data-id="${contact.id}">Edit</button> <button class="delete-contact" data-id="${contact.id}">Delete</button>`).appendTo(row);

            searchTableBody.append(row);
        });
    }).fail(jqXHR => console.log(`Error fetching contacts: ${jqXHR.statusText}`));
  });
});
</script>
</body>
</html>



