<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Contact Manager</title>
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/handlebars.js"></script>
<style>
body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
}

header {
  background-color: #2c3e50;
  color: white;
  text-align: center;
  padding: 10px 0;
}

#main-container {
  text-align: center;
  margin-top: 20px;
}

button {
  padding: 10px 20px;
  background-color: #2c3e50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 10px;
}

form {
  text-align: center;
  margin-top: 20px;
}

label {
  display: block;
  margin-bottom: 5px;
}

input[type="text"],
input[type="email"],
input[type="tel"] {
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  width: 100%;
  margin-bottom: 10px;
}

input[type="submit"],
button[type="submit"],
button[type="button"] {
  padding: 10px 20px;
  background-color: #2c3e50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #ccc;
}

th {
  background-color: #2c3e50;
  color: white;
}

h1 a {
  text-decoration: none;
  color: white;
}

h2 {
  text-align: center;
}

#new-contact-form,
#edit-contact-form,
#all-contacts-table,
#search-results-table {
  display: none;
  padding: 20px;
  background-color: #f2f2f2;
  border-radius: 5px;
  margin-top: 20px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}

#new-contact-form h2,
#edit-contact-form h2,
#all-contacts-table h2,
#search-results-table h2 {
  margin-top: 0;
}

#search-results-table {
  margin-top: 40px;
}

#search-results-table button {
  margin-right: 10px;
}

#new-contact-form {
  display: none;
  padding: 20px;
  background-color: #f2f2f2;
  border-radius: 5px;
  margin-top: 20px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  max-width: 400px; /* Add this line to limit the width */
  margin-left: auto; /* Add this line to center the form horizontally */
  margin-right: auto; /* Add this line to center the form horizontally */
}


@media only screen and (min-width: 768px) {
  #main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
/*    justify-content: center;*/
    height: calc(100vh - 50px);
  }

  #search-form {
    margin-top: 20px;
  }
}

@media only screen and (max-width: 600px) {
  #main-container {
    margin-top: 50px;
  }

  #search-form {
    margin-top: 10px;
  }

  button {
    width: 100%;
    margin-bottom: 10px;
  }

  #new-contact-form,
  #edit-contact-form,
  #all-contacts-table,
  #search-results-table {
    padding: 10px;
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"] {
    width: 100%;
    margin-bottom: 10px;
  }

  table {
    font-size: 14px;
  }

  th, td {
    padding: 5px;
  }

  #new-contact-form {
    max-width: 100%;
    margin-left: 10px;
    margin-right: 10px;
  }
}

@media only screen and (min-width: 601px) and (max-width: 1024px) {
  #main-container {
    margin-top: 50px;
  }

  #search-form {
    margin-top: 10px;
  }

  button {
    width: 100%;
    margin-bottom: 10px;
  }

  #new-contact-form,
  #edit-contact-form,
  #all-contacts-table,
  #search-results-table {
    padding: 20px;
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"] {
    width: 100%;
    margin-bottom: 10px;
  }

  table {
    font-size: 16px;
  }

  #new-contact-form {
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
}

@media only screen and (min-width: 1025px) {
  #main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: calc(100vh - 50px);
  }

  #search-form {
    margin-top: 20px;
  }

  button {
    margin-right: 10px;
  }

  #new-contact-form,
  #edit-contact-form,
  #all-contacts-table,
  #search-results-table {
    padding: 20px;
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"] {
    width: 300px;
    margin-right: 10px;
  }

  input[type="submit"],
  button[type="submit"],
  button[type="button"] {
    margin-left: 10px;
  }

  table {
    font-size: 18px;
  }

  #new-contact-form {
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
}

</style>
</head>
<body>
  <header>
    <h1><a href="http://localhost:3000/index.html">Contact Manager</a></h1>
  </header>
   <div id="main-container">
    <button id="add-contact-button">Add Contact</button>
    <br><br>
    <button id="view-contacts-button">View Contacts</button>
    <br><br>
    <form id="search-form">
      <input type="text" id="search-input" name="search" placeholder="search">
      <button type="submit" id="search-button">Search</button>
    </form>
  </div>
  <br>
  <div id="new-contact-form">
    <h2>Add a New Contact:</h2>
    <form>
      <label for="full-name">Full Name:</label>
      <input type="text" id="add-full-name" name="full-name">
      <br><br>
      <label for="email-address">Email Address:</label>
      <input type="email" id="add-email-address" name="email-address">
      <br><br>
      <label for="telephone-number">Telephone Number:</label>
      <input type="tel" id="add-telephone-number" name="telephone-number">
      <br><br>
      <label for="tags">Tags:</label>
      <input type="text" id="add-tags" name="tags">
      <br><br>
      <button type="submit">Submit</button>
      <button type="button" id="cancel-new-contact">Cancel</button>
    </form>
  </div>
  <div id="edit-contact-form">
    <h2>Edit Contact:</h2>
    <form>
      <label for="full-name">Full Name:</label>
      <input type="text" id="full-name" name="full-name">
      <br><br>
      <label for="email-address">Email Address:</label>
      <input type="email" id="email-address" name="email-address">
      <br><br>
      <label for="telephone-number">Telephone Number:</label>
      <input type="tel" id="telephone-number" name="telephone-number">
      <br><br>
      <label for="tags">Tags:</label>
      <input type="text" id="tags" name="tags">
      <br><br>
      <button type="submit" id="update-edit-contact">Update</button>
      <button type="button" id="cancel-edit-contact">Cancel</button>
    </form>
  </div>
  <div id="all-contacts-table">
    <h2>Contact List:</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <br><br>
    <button type="button" id="home-button">Home</button>
  </div>
  <div id="search-results-table" style="display:none">
    <h2>Search Results:</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <br><br>
    <button type="button" id="search-results-home-button">Home</button>
    <button type="button" id="view-all-contacts-button">View All Contacts</button>
  </div>
<script>

$(document).ready(function() {
  $('#new-contact-form, #all-contacts-table, #edit-contact-form, #search-results-table').hide();
  $('#add-contact-button').click(() => $('#main-container').hide() && $('#new-contact-form').show());

  function createTagLinks(tags) {
    return tags
      ? tags.split(",").map((tag) => {
          const link = $("<a></a>")
            .text(tag.trim())
            .attr("href", "");
          link.click(function (event) {
            event.preventDefault();
            const searchTag = tag.trim();
            console.log('searchTag: ', searchTag);
            $('#search-input').val(searchTag); // add tag to search form
            $('#main-container').hide(); // hide the main container
            $.get(
              "http://localhost:3000/api/contacts?tags=" + encodeURI(searchTag),
              function (response) {
                const resultsTableBody = $("#search-results-table tbody");
                resultsTableBody.empty();
                response.forEach(function (contact) {
                  var row = $("<tr></tr>");
                  row.append($("<td></td>").text(contact.name));
                  row.append($("<td></td>").text(contact.phone));
                  row.append($("<td></td>").text(contact.email));
                  row.append($("<td></td>").text(contact.tags));
                  const updateButton = $("<button></button>")
                    .text("Update")
                    .click(function () {
                      showEditForm(contact.id);
                    });
                  row.append(updateButton);
                  resultsTableBody.append(row);
                });
                $("#all-contacts-table").hide();
                $("#search-results-table").show(); // display search results table
              }
            );
          });
          return link[0].outerHTML;
        })
      : "";
  }

  // function to fetch contacts from server and update table
  function fetchContacts() {
    $.get('http://localhost:3000/api/contacts', function(response) {
      // remove existing rows from table
      $('#all-contacts-table tbody tr').remove();

      response.forEach(function(contact) {
        var row = $('<tr></tr>');
        $('<td></td>').text(contact.full_name).appendTo(row);
        $('<td></td>').text(contact.phone_number).appendTo(row);
        $('<td></td>').text(contact.email).appendTo(row);

        var tagSpan = $('<span></span>');
        let tagLinks = createTagLinks(contact.tags);
        tagLinks.forEach(function(link, index) {
          if (index > 0) {
            $('<span>, </span>').appendTo(tagSpan);
          }
          tagSpan.append(link);
        });
        $('<td></td>').append(tagSpan).appendTo(row);

        // add edit and delete buttons to the Edit column
        $('<td></td>').html('<button class="edit-contact" data-id="' + contact.id + '">Edit</button> <button class="delete-contact" data-id="' + contact.id + '">Delete</button>').appendTo(row);

        $('#all-contacts-table tbody').append(row);
      });

      $('.delete-contact').click(function() {
        var contactId = $(this).data('id');
        $.ajax({
          method: 'DELETE',
          url: 'http://localhost:3000/api/contacts/' + contactId,
          context: this, // save reference to clicked element
          success: function(response) {
            alert('Successfully deleted contact!');
            $(this).closest('tr').remove();
          },
          error: function(xhr, status, error) {
            alert('Error deleting contact :(');
            console.log('Error:', error);
          }
        });
      });

      $('.edit-contact').click(function() {
        var contactId = $(this).data('id');
        $('#all-contacts-table').hide();
        
        $.get('http://localhost:3000/api/contacts/' + contactId, function(response) {
          $('#edit-contact-form #full-name').val(response.full_name);
          $('#edit-contact-form #telephone-number').val(response.phone_number);
          $('#edit-contact-form #email-address').val(response.email);
          $('#edit-contact-form #tags').val(response.tags);

          $('<input>').attr({
            type: 'hidden',
            name: 'id',
            value: contactId
          }).appendTo('#edit-contact-form');
          
          $('#edit-contact-form').show();
        });
      });
    });
  }

  fetchContacts();

  $('#view-contacts-button').click(function() {$('#main-container').hide(); $('#all-contacts-table').show(); fetchContacts();});
  $('#cancel-new-contact').click(function() {$('#new-contact-form').hide(); $('#main-container').show();});
  $('#cancel-edit-contact').click(function() {$('#edit-contact-form').hide(); $('#all-contacts-table').show();});
  $('#home-button').click(function() {$('#all-contacts-table').hide(); $('#main-container').show();});
  $("#search-results-home-button").click(function() {$('#search-results-table').hide(); $('#main-container').show();});
  $('#view-all-contacts-button').click(function() {$('#search-results-table').hide(); $('#all-contacts-table').show(); fetchContacts();});

  $('#search-button').click(function() {
    $('#main-container').hide();
    $.get(
      "http://localhost:3000/api/contacts?tags=" + encodeURI($('#search-form #search').val()),
      function (response) {
        const resultsTableBody = $("#search-results-table tbody");
        resultsTableBody.empty();
        response.forEach(function (contact) {
          var row = $("<tr></tr>");
          row.append($("<td></td>").text(contact.name));
          row.append($("<td></td>").text(contact.phone));
          row.append($("<td></td>").text(contact.email));
          row.append($("<td></td>").text(contact.tags));
          const updateButton = $("<button></button>")
            .text("Update")
            .click(function () {
              showEditForm(contact.id);
            });
          row.append(updateButton);
          resultsTableBody.append(row);
        });
        $("#all-contacts-table").hide();
        $("#search-results-table").show();
      }
    );
  });

  $('#new-contact-form form').submit(function(event) {
    event.preventDefault();

    var formData = {
      full_name: $('#add-full-name').val(),
      email: $('#add-email-address').val(),
      phone_number: $('#add-telephone-number').val(),
      tags: $('#add-tags').val()
    };

    $.ajax({
      method: 'POST',
      url: 'http://localhost:3000/api/contacts/',
      data: formData,
      success: function(response) {
        alert('Successfully added new contact!');
        $('#new-contact-form').hide();
        $('#main-container').show();
        $('#new-contact-form form')[0].reset();
      },
      error: function(xhr, status, error) {
        alert('Error adding new contact :(');
        console.log('Error:', error);
      }
    });
  });

  $('#edit-contact-form form').submit(function(event) {
    event.preventDefault(); 
    var contactId = $('#edit-contact-form input[type=hidden]').val();

    var formData = {
      full_name: $('#edit-contact-form #full-name').val(),
      email: $('#edit-contact-form #email-address').val(),
      phone_number: $('#edit-contact-form #telephone-number').val(),
      tags: $('#edit-contact-form #tags').val()
    };

    $.ajax({
      method: 'PUT',
      url: 'http://localhost:3000/api/contacts/' + contactId,
      data: formData,
      success: function(response) {
        alert('Successfully updated contact!');
        $('#edit-contact-form input[name="id"]').remove();
        $('#edit-contact-form').hide();
        $('#all-contacts-table').show();
        fetchContacts();
      },
      error: function(xhr, status, error) {
        alert('Error updating contact :(');
        console.log('Error:', error);
      }
    });
  });

  $('#search-form').submit(function(event) {
    event.preventDefault();
    const searchTerm = $('#search-input').val().trim().toLowerCase();

    $.get('/api/contacts', function(response) {
        const filteredContacts = response.filter(contact => ['full_name', 'email', 'phone_number', 'tags'].some(field => contact[field].toLowerCase().includes(searchTerm)));

        $('#all-contacts-table').hide();
        $('#search-results-table').show();

        const searchTableBody = $('#search-results-table tbody');
        searchTableBody.empty();

        filteredContacts.forEach(contact => {
            const row = $('<tr></tr>');
            $('<td></td>').text(contact.full_name).appendTo(row);
            $('<td></td>').text(contact.phone_number).appendTo(row);
            $('<td></td>').text(contact.email).appendTo(row);

            const tagSpan = $('<span></span>');
            createTagLinks(contact.tags).forEach((link, index) => {
                if (index > 0) $('<span>, </span>').appendTo(tagSpan);
                tagSpan.append(link);
            });
            $('<td></td>').append(tagSpan).appendTo(row);

            $('<td></td>').html(`<button class="edit-contact" data-id="${contact.id}">Edit</button> <button class="delete-contact" data-id="${contact.id}">Delete</button>`).appendTo(row);

            searchTableBody.append(row);
        });
    }).fail(jqXHR => console.log(`Error fetching contacts: ${jqXHR.statusText}`));
  });

  $('.tag-link').on('click', function(event) {
    // Prevent the default behavior of following the link
    event.preventDefault();

    // Retrieve the tag name from the link's data attribute
    var tagName = $(this).data('tag');

    // Perform an AJAX request to retrieve the search results for the clicked tag
    $.ajax({
      url: '/search',
      method: 'GET',
      data: {
        tag: tagName
      },
      success: function(response) {
        // Update the table to display only the search results
        $('#all-contacts-table tbody tr').remove();
        $('#all-contacts-table tbody').append(response);
      },
      error: function(error) {
        console.log(error);
      }
    });
  });

});
</script>
</body>
</html>



